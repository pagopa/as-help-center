<script>
    // Redirect to new request page if user is already signed in
    {{#if signed_in}}
        window.location.href = '/hc/' + (LotusUtils.getLocale ? LotusUtils.getLocale() : 'it') + '/requests/new';
        return;
    {{/if}}
</script>

<div class="lt-main-content lt-bg-light">
    <div class="lt-container">
        <div class="lt-container-inner lt-contact-email-page">

            <h1 class="lt-email-login-title">{{settings.email_contact_form_title}}</h1>
            <p class="lt-email-login-subtitle">
                {{settings.email_contact_form_subtitle}}
            </p>

            <div class="email-contact-alert-error-wrapper">
                <div class="lt-container-inner rte info-block lt-mb-6 email-contact-alert-error" id="info-block" role="region" aria-labelledby="banner-title" style="" aria-hidden="true">
                    <div class="callout danger callout--danger">
                        <p id="error-message" role="alert" aria-live="assertive">{{settings.email_contact_match_title_error}}</p>
                    </div>
                </div>
            </div>

            <form id="contact-email-form" class="lt-email-login-form" aria-label="Modulo per inserimento email di contatto">

                <div class="input-container lt-mb-3">
                    <label class="mdc-text-field extended mdc-text-field--outlined">
                        <span class="mdc-notched-outline">
                            <span class="mdc-notched-outline__leading"></span>
                            <span class="mdc-notched-outline__notch">
                            <span class="mdc-floating-label" id="email-label">{{settings.email_contact_email_input}}</span>
                            </span>
                            <span class="mdc-notched-outline__trailing"></span>
                        </span>
                    <input type="email" class="mdc-text-field__input custom-validation"
                            aria-labelledby="email-label" aria-describedby="email-helper" 
                            aria-required="true" required autocomplete="email" id="email"
                            name="email" value="">
                    </label>
                    <div class="mdc-text-field-helper-line">
                    <div id="email-helper" class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg" aria-hidden="true">
                        {{settings.email_contact_helper}}
                    </div>
                    </div>
                </div>

                <div class="input-container lt-mb-3">
                    <label class="mdc-text-field extended mdc-text-field--outlined">
                        <span class="mdc-notched-outline">
                            <span class="mdc-notched-outline__leading"></span>
                            <span class="mdc-notched-outline__notch">
                            <span class="mdc-floating-label" id="email-repeat-label">{{settings.email_contact_repeat_input}}</span>
                            </span>
                            <span class="mdc-notched-outline__trailing"></span>
                        </span>
                    <input type="email" class="mdc-text-field__input custom-validation"
                            aria-labelledby="email-repeat-label" aria-describedby="email-repeat-helper" 
                            aria-required="true" required autocomplete="off" id="email-repeat"
                            name="email-repeat" value="">
                    </label>
                    <div class="mdc-text-field-helper-line">
                    <div id="email-repeat-helper" class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg" aria-hidden="true">
                        {{settings.email_contact_repeat_helper}}
                    </div>
                    </div>
                </div>

                <div class="lt-btn-container">
                    <button type="button" id="btn-back" class="lt-btn lt-btn--square lt-btn--outline" aria-label="Torna alla pagina precedente">{{settings.email_contact_back_btn}}</button>
                    <button type="submit" class="lt-btn lt-btn--square lt-btn--primary" id="btn-submit" aria-label="Conferma e procedi">
                        <i class="fa-solid fa-circle-notch fa-spin lt-me-2 submit-spinner" aria-hidden="true" style="display:none;"></i>
                        <span class="submit-text">{{settings.email_contact_confirm_btn}}</span>
                    </button>
                </div>
                
                <!-- Screen reader announcement for form submission -->
                <div class="sr-only" id="sr-submit-status" aria-live="polite" aria-atomic="true"></div>
            </form>

            <div class="lt-email-login-footer">
                <p class="lt-email-login-footer-title">{{settings.email_contact_note_title}}</p>
                <p format-text>{{settings.email_contact_note_subtitle}}</p>
            </div>

        </div>
    </div>
</div>

<script type="module">
    // setup: https://m2.material.io/develop/web/getting-started
    // components:
    //    https://m2.material.io/components?platform=web
    //    https://github.com/material-components/material-components-web/tree/v12.0.0/packages
    // guidelines: https://main--633c31eff9fe385398ada426.chromatic.com/
    window.addEventListener('DOMContentLoaded', () => {
        // MDC init
        // text-field
        document.querySelectorAll('.mdc-text-field').forEach((el) => {
            mdc.textField.MDCTextField.attachTo(el);
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById('contact-email-form');
        if (!form) return;

        const errorBox = document.getElementById('info-block');
        const errorMessageEl = document.getElementById('error-message');
        const hideErrorBox = () => {
            if (errorBox) {
                errorBox.style.opacity = '0';
                setTimeout(() => {
                    errorBox.style.display = 'none';
                    errorBox.setAttribute('aria-hidden', 'true');
                }, 300); // match transition duration
            }
        };
        const showErrorBox = (errorMessage) => {
            if (errorBox) {
                errorBox.style.display = 'block';
                // Force reflow to ensure transition works
                errorBox.offsetHeight;
                errorBox.style.opacity = '1';
                errorBox.setAttribute('aria-hidden', 'false');
            }
            if (errorMessageEl && errorMessage) {
                // textContent to avoid injecting HTML
                errorMessageEl.textContent = errorMessage;
            }
        };
        
        const setFieldInvalidA11y = (field) => {
            if (!field) return;
            field.setAttribute('aria-invalid', 'true');
        };
        
        const clearFieldInvalidA11y = (field) => {
            if (!field) return;
            field.removeAttribute('aria-invalid');
        };

        // initialize by hiding error box
        hideErrorBox();

        // enable/disable submit and show spinner
        const submitBtn = document.getElementById('btn-submit');
        const submitSpinner = submitBtn && submitBtn.querySelector('.submit-spinner');
        const submitText = submitBtn && submitBtn.querySelector('.submit-text');
        const srSubmitStatus = document.getElementById('sr-submit-status');
        
        const disableSubmit = () => {
            if (submitBtn) {
                submitBtn.setAttribute('disabled', 'disabled');
                submitBtn.setAttribute('aria-busy', 'true');
                submitBtn.setAttribute('aria-label', 'Invio in corso...');
            } 
            if (submitSpinner) submitSpinner.style.display = 'inline-block';
            if (srSubmitStatus) {
                srSubmitStatus.textContent = 'Invio in corso...';
            }
        };
        const enableSubmit = () => {
            if (submitBtn) {
                submitBtn.removeAttribute('disabled');
                submitBtn.removeAttribute('aria-busy');
                submitBtn.setAttribute('aria-label', 'Conferma e procedi');
            }
            if (submitSpinner) submitSpinner.style.display = 'none';
            if (srSubmitStatus) {
                srSubmitStatus.textContent = '';
            }
        };

        enableSubmit();

        // Reset submit button state when user navigates back
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Page was loaded from back/forward cache
                enableSubmit();
                hideErrorBox();
                clearFieldInvalidA11y(emailEl);
                clearFieldInvalidA11y(emailRepeatEl);
            }
        });

        const emailEl = document.getElementById('email');
        const emailRepeatEl = document.getElementById('email-repeat');
        // hide error alert and clear invalid state when user modifies inputs
        if (emailEl) {
            emailEl.addEventListener('input', function() {
                hideErrorBox();
                clearFieldInvalidA11y(emailEl);
            });
        }
        if (emailRepeatEl) {
            emailRepeatEl.addEventListener('input', function() {
                hideErrorBox();
                clearFieldInvalidA11y(emailRepeatEl);
            });
        }

        const brandId = '{{brand.id}}';
        const remoteAuthId = '{{settings.sso_remote_auth_id}}';
        const zendeskBase = '{{settings.sso_login_address}}';

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const email = emailEl && emailEl.value && emailEl.value.trim();
            const emailRepeat = emailRepeatEl && emailRepeatEl.value && emailRepeatEl.value.trim();

            if (!email || !emailRepeat) {
                showErrorBox('{{settings.email_contact_required_error}}');
                if (!email) setFieldInvalidA11y(emailEl);
                if (!emailRepeat) setFieldInvalidA11y(emailRepeatEl);
                const firstInvalid = !email ? emailEl : emailRepeatEl;
                if (firstInvalid) firstInvalid.focus();
                return;
            }
            if (!isValidEmail(email)) {
                showErrorBox('{{settings.email_contact_format_error}}');
                setFieldInvalidA11y(emailEl);
                if (emailEl) emailEl.focus();
                return;
            }
            if (email !== emailRepeat) {
                showErrorBox('{{settings.email_contact_match_error}}');
                setFieldInvalidA11y(emailEl);
                setFieldInvalidA11y(emailRepeatEl);
                if (emailEl) emailEl.focus();
                return;
            }

            disableSubmit();

            // Build return_to URL (origin + path) and ensure proper encoding
            const origin = window.location.origin || (window.location.protocol + '//' + window.location.host);
            const returnToPath = origin + '/hc/' + LotusUtils.getLocale() + '{{settings.sso_return_to_address}}' + '?contact_email=' + encodeURIComponent(email);
            const params = new URLSearchParams({
                auth_origin: brandId,
                brand_id: brandId,
                locale: LotusUtils.getLocale(),
                remote_auth_id: remoteAuthId,
                return_to: returnToPath
            });

            const finalUrl = zendeskBase + '?' + params.toString();

            // Redirect to Zendesk SSO
            // console.log(finalUrl);
            window.location.href = finalUrl;
        });

        // Back button behavior: go back only if referrer is same domain, else go to home
        const backBtn = document.getElementById('btn-back');
        if (backBtn) {
            backBtn.addEventListener('click', function (ev) {

                const goToHome = () => {
                    const homeLink = (window.location.origin || '/') + '/hc/' + LotusUtils.getLocale();
                    window.location.href = homeLink;
                }

                try {
                    const ref = document.referrer;
                    if (ref) {
                        const refUrl = new URL(ref);
                        const currentOrigin = window.location.origin || (window.location.protocol + '//' + window.location.host);
                        const currentHost = new URL(currentOrigin).host;
                        if (refUrl.host === currentHost) {
                            // same domain, go back in history
                            window.location.href = refUrl.pathname;
                            return;
                        }
                    }
                } catch (err) {
                    // fallback to home
                    goToHome();
                    return
                }
                // fallback to home
                goToHome();
                return;
            });
        }
    });
</script>