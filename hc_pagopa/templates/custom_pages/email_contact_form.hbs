<div class="lt-main-content lt-bg-light">
    <div class="lt-container">
        <div class="lt-container-inner lt-contact-email-page">

            <h1 class="lt-email-login-title">{{settings.email_contact_form_title}}</h1>
            <p class="lt-email-login-subtitle">
                {{settings.email_contact_form_subtitle}}
            </p>

            <div class="email-contact-alert-error-wrapper">
                <div class="lt-container-inner rte info-block lt-mb-6 email-contact-alert-error" id="info-block" role="region" aria-labelledby="banner-title" style="" aria-hidden="true">
                    <div class="callout danger callout--danger">
                        <p id="error-message">Si Ã¨ verificato un errore</p>
                    </div>
                </div>
            </div>

            <form id="contact-email-form" class="lt-email-login-form">

                <div class="input-container lt-mb-3">
                    <label class="mdc-text-field extended mdc-text-field--outlined">
                        <span class="mdc-notched-outline">
                            <span class="mdc-notched-outline__leading"></span>
                            <span class="mdc-notched-outline__notch">
                            <span class="mdc-floating-label" id="email-label">{{settings.email_contact_email_input}}</span>
                            </span>
                            <span class="mdc-notched-outline__trailing"></span>
                        </span>
                    <input type="email" class="mdc-text-field__input custom-validation"
                            aria-labelledby="email-label" required autocomplete="email" id="email"
                            name="email" value="">
                    </label>
                    <div class="mdc-text-field-helper-line">
                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg"
                        aria-hidden="true">
                        {{settings.email_contact_email_helper_text}}
                    </div>
                    </div>
                </div>

                <div class="input-container lt-mb-3">
                    <label class="mdc-text-field extended mdc-text-field--outlined">
                        <span class="mdc-notched-outline">
                            <span class="mdc-notched-outline__leading"></span>
                            <span class="mdc-notched-outline__notch">
                            <span class="mdc-floating-label" id="email-repeat-label">{{settings.email_contact_email_repeat_input}}</span>
                            </span>
                            <span class="mdc-notched-outline__trailing"></span>
                        </span>
                    <input type="text" class="mdc-text-field__input custom-validation"
                            aria-labelledby="email-repeat-label" required autocomplete="off" id="email-repeat"
                            name="email-repeat" value="">
                    </label>
                    <div class="mdc-text-field-helper-line">
                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg"
                        aria-hidden="true">
                        {{settings.email_contact_email_repeat_helper_text}}
                    </div>
                    </div>
                </div>

                <div class="lt-btn-container">
                    <button type="button" id="btn-back" class="lt-btn lt-btn--square lt-btn--outline">{{settings.email_contact_back_btn}}</button>
                    <button type="submit" class="lt-btn lt-btn--square lt-btn--primary">
                        {{settings.email_contact_confirm_btn}}
                    </button>
                </div>
            </form>

            <div class="lt-email-login-footer">
                <p class="lt-email-login-footer-title">{{settings.email_contact_note_title}}</p>
                <p format-text>{{settings.email_contact_note_subtitle}}</p>
            </div>

        </div>
    </div>
</div>

<script type="module">
    // setup: https://m2.material.io/develop/web/getting-started
    // components:
    //    https://m2.material.io/components?platform=web
    //    https://github.com/material-components/material-components-web/tree/v12.0.0/packages
    // guidelines: https://main--633c31eff9fe385398ada426.chromatic.com/
    window.addEventListener('DOMContentLoaded', () => {
        // MDC init
        // text-field
        document.querySelectorAll('.mdc-text-field').forEach((el) => {
            mdc.textField.MDCTextField.attachTo(el);
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById('contact-email-form');
        if (!form) return;

        const errorBox = document.getElementById('info-block');
        const errorMessageEl = document.getElementById('error-message');
        const hideErrorBox = () => {
            if (errorBox) {
                errorBox.style.opacity = '0';
                setTimeout(() => {
                    errorBox.style.display = 'none';
                    errorBox.setAttribute('aria-hidden', 'true');
                }, 300); // match transition duration
            }
        };
        const showErrorBox = (errorMessage) => {
            if (errorBox) {
                errorBox.style.display = 'block';
                // Force reflow to ensure transition works
                errorBox.offsetHeight;
                errorBox.style.opacity = '1';
                errorBox.setAttribute('aria-hidden', 'false');
            }
            if (errorMessageEl && errorMessage) {
                // textContent to avoid injecting HTML
                errorMessageEl.textContent = errorMessage;
            }
        };

        // initialize by hiding error box
        hideErrorBox();

        const emailEl = document.getElementById('email');
        const emailRepeatEl = document.getElementById('email-repeat');
        // hide error alert when user modifies inputs
        if (emailEl) emailEl.addEventListener('input', hideErrorBox);
        if (emailRepeatEl) emailRepeatEl.addEventListener('input', hideErrorBox);

        const brandId = '{{brand.id}}';
        const remoteAuthId = '{{settings.sso_remote_auth_id}}';
        const zendeskBase = '{{settings.sso_login_address}}';

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const email = emailEl && emailEl.value && emailEl.value.trim();
            const emailRepeat = emailRepeatEl && emailRepeatEl.value && emailRepeatEl.value.trim();

            if (!email || !emailRepeat) {
                showErrorBox('{{settings.email_contact_form_fields_required_error}}');
                if (emailEl) emailEl.focus();
                return;
            }
            if (!isValidEmail(email)) {
                showErrorBox('{{settings.email_contact_form_email_format_error}}');
                if (emailEl) emailEl.focus();
                return;
            }
            if (email !== emailRepeat) {
                showErrorBox('{{settings.email_contact_form_email_match_error}}');
                if (emailEl) emailEl.focus();
                return;
            }

            // Build return_to URL (origin + path) and ensure proper encoding
            const origin = window.location.origin || (window.location.protocol + '//' + window.location.host);
            const returnToPath = origin + '/hc/' + LotusUtils.getLocale() + '{{settings.sso_return_to_address}}' + '?contact_email=' + encodeURIComponent(email);
            const params = new URLSearchParams({
                auth_origin: brandId,
                brand_id: brandId,
                locale: LotusUtils.getLocale(),
                remote_auth_id: remoteAuthId,
                return_to: returnToPath
            });

            const finalUrl = zendeskBase + '?' + params.toString();

            // Redirect to Zendesk SSO
            // console.log(finalUrl);
            window.location.href = finalUrl;
        });

        // Back button behavior: go back only if referrer is same domain, else go to home
        const backBtn = document.getElementById('btn-back');
        if (backBtn) {
            backBtn.addEventListener('click', function (ev) {

                const goToHome = () => {
                    const homeLink = (window.location.origin || '/') + '/hc/' + LotusUtils.getLocale();
                    window.location.href = homeLink;
                }

                try {
                    const ref = document.referrer;
                    if (ref) {
                        const refUrl = new URL(ref);
                        console.log('refUlr', refUrl);
                        const currentOrigin = window.location.origin || (window.location.protocol + '//' + window.location.host);
                        const currentHost = new URL(currentOrigin).host;
                        if (refUrl.host === currentHost) {
                            // same domain, go back in history
                            window.location.href = refUrl.pathname;
                            return;
                        }
                    }
                } catch (err) {
                    // fallback to home
                    goToHome();
                    return
                }
                // fallback to home
                goToHome();
                return;
            });
        }
    });
</script>